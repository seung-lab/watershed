More literal translation of Zlateski's C++ code